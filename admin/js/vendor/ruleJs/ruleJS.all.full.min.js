var ruleJS=function(t){"use strict";var e=this,r=document.getElementById(t)||null,n={},a={errors:[{type:"NULL",output:"#NULL"},{type:"DIV_ZERO",output:"#DIV/0!"},{type:"VALUE",output:"#VALUE!"},{type:"REF",output:"#REF!"},{type:"NAME",output:"#NAME?"},{type:"NUM",output:"#NUM!"},{type:"NOT_AVAILABLE",output:"#N/A!"},{type:"ERROR",output:"#ERROR"},{type:"NEED_UPDATE",output:"#NEED_UPDATE"}],get:function(t){var e=a.errors.filter(function(e){return e.type===t||e.output===t})[0];return e?e.output:null}},i=function(){this.data=[];var t=["input[type=text]","[data-formula]"];this.getItem=function(t){return e.matrix.data.filter(function(e){return e.id===t})[0]},this.removeItem=function(t){e.matrix.data=e.matrix.data.filter(function(e){return e.id!==t})},this.removeItemsInCol=function(t){e.matrix.data=e.matrix.data.filter(function(e){return e.col!==t})},this.removeItemsInRow=function(t){e.matrix.data=e.matrix.data.filter(function(e){return e.row!==t})},this.removeItemsBelowCol=function(t){e.matrix.data=e.matrix.data.filter(function(e){return e.col<t})},this.removeItemsBelowRow=function(t){e.matrix.data=e.matrix.data.filter(function(e){return e.row<t})},this.updateItem=function(t,r){if(e.utils.isString(t)&&(t=e.matrix.getItem(t)),t&&r)for(var n in r)t[n]&&e.utils.isArray(t[n])?e.utils.isArray(r[n])?r[n].forEach(function(e){-1===t[n].indexOf(e)&&t[n].push(e)}):-1===t[n].indexOf(r[n])&&t[n].push(r[n]):t[n]=r[n]},this.addItem=function(t){var r=t.id,n=e.utils.cellCoords(r);t.row=n.row,t.col=n.col;var a=e.matrix.data.filter(function(t){return t.id===r})[0];return a?e.matrix.updateItem(a,t):e.matrix.data.push(t),e.matrix.getItem(r)},this.getRefItemsToColumn=function(t){var r=[];return e.matrix.data.length?(e.matrix.data.forEach(function(n){n.deps&&(n.deps.filter(function(r){var n=e.utils.getCellAlphaNum(r).alpha;return e.utils.toNum(n)>=t}).length>0&&-1===r.indexOf(n.id)&&r.push(n.id))}),r):r},this.getRefItemsToRow=function(t){var r=[];return e.matrix.data.length?(e.matrix.data.forEach(function(n){n.deps&&(n.deps.filter(function(r){return e.utils.getCellAlphaNum(r).num>t}).length>0&&-1===r.indexOf(n.id)&&r.push(n.id))}),r):r},this.updateElementItem=function(t,r){var n=t.getAttribute("id"),a=e.matrix.getItem(n);e.matrix.updateItem(a,r)},this.getDependencies=function(t){var r=[],n=function(t){var a,i,u=(a=t,i=[],e.matrix.data.filter(function(t){if(t.deps)return t.deps.indexOf(a)>-1}).forEach(function(t){-1===i.indexOf(t.id)&&i.push(t.id)}),i);u.length&&u.forEach(function(t){-1===r.indexOf(t)&&(r.push(t),e.matrix.getItem(t).deps.length&&n(t))})};return n(t),r},this.getElementDependencies=function(t){return e.matrix.getDependencies(t.getAttribute("id"))};var n=function(t,r){var n=o(t,r),a=n.result,i=n.error,u=r.nodeName.toUpperCase();return e.matrix.updateElementItem(r,{value:a,error:i}),-1===["INPUT"].indexOf(u)&&(r.innerText=a||i),r.value=a||i,n},a=function(t){var r=t.getAttribute("id"),a=t.getAttribute("data-formula");a&&(e.matrix.addItem({id:r,formula:a}),n(a,t))},i=function(t){var r=t.getAttribute("id");t.addEventListener("dblclick",function(){var n=e.matrix.getItem(r);n&&n.formula&&(n.formulaEdit=!0,t.value="="+n.formula)}),t.addEventListener("blur",function(){var n=e.matrix.getItem(r);n&&(n.formulaEdit&&(t.value=n.value||n.error),n.formulaEdit=!1)}),t.addEventListener("keyup",function(t){switch(t.keyCode){case 13:case 27:document.activeElement&&document.activeElement!==document.body?document.activeElement.blur():document.activeElement||document.body.focus()}}),t.addEventListener("change",function(){e.matrix.removeItem(r);var i=t.value;"="===i[0]&&(t.setAttribute("data-formula",i.substr(1)),a(t)),function(t){var r=e.matrix.getElementDependencies(t);t.getAttribute("id");r.forEach(function(t){var r=e.matrix.getItem(t);if(r&&r.formula){var a=document.getElementById(t);n(r.formula,a)}})}(t)})};this.depsInFormula=function(t){var e=t.formula,r=t.deps;return!!r&&(r=r.filter(function(t){return-1!==e.indexOf(t)})).length>0},this.scan=function(){var e=r.querySelectorAll(t);[].slice.call(e).forEach(function(t){a(t),i(t)})}},u={SUPPORTED_FORMULAS:["ABS","ACCRINT","ACOS","ACOSH","ACOTH","AND","ARABIC","ASIN","ASINH","ATAN","ATAN2","ATANH","AVEDEV","AVERAGE","AVERAGEA","AVERAGEIF","BASE","BESSELI","BESSELJ","BESSELK","BESSELY","BETADIST","BETAINV","BIN2DEC","BIN2HEX","BIN2OCT","BINOMDIST","BINOMDISTRANGE","BINOMINV","BITAND","BITLSHIFT","BITOR","BITRSHIFT","BITXOR","CEILING","CEILINGMATH","CEILINGPRECISE","CHAR","CHISQDIST","CHISQINV","CODE","COMBIN","COMBINA","COMPLEX","CONCATENATE","CONFIDENCENORM","CONFIDENCET","CONVERT","CORREL","COS","COSH","COT","COTH","COUNT","COUNTA","COUNTBLANK","COUNTIF","COUNTIFS","COUNTIN","COUNTUNIQUE","COVARIANCEP","COVARIANCES","CSC","CSCH","CUMIPMT","CUMPRINC","DATE","DATEVALUE","DAY","DAYS","DAYS360","DB","DDB","DEC2BIN","DEC2HEX","DEC2OCT","DECIMAL","DEGREES","DELTA","DEVSQ","DOLLAR","DOLLARDE","DOLLARFR","E","EDATE","EFFECT","EOMONTH","ERF","ERFC","EVEN","EXACT","EXPONDIST","FALSE","FDIST","FINV","FISHER","FISHERINV","IF","INT","ISEVEN","ISODD","LN","LOG","LOG10","MAX","MAXA","MEDIAN","MIN","MINA","MOD","NOT","ODD","OR","PI","POWER","ROUND","ROUNDDOWN","ROUNDUP","SIN","SINH","SPLIT","SQRT","SQRTPI","SUM","SUMIF","SUMIFS","SUMPRODUCT","SUMSQ","SUMX2MY2","SUMX2PY2","SUMXMY2","TAN","TANH","TRUE","TRUNC","XOR"],number:function(t){switch(typeof t){case"number":return t;case"string":if(!isNaN(t))return t.indexOf(".")>-1?parseFloat(t):parseInt(t,10)}return t},string:function(t){return t.substring(1,t.length-1)},numberInverted:function(t){return-1*this.number(t)},specialMatch:function(t,e,r){var n;switch(t){case"&":n=e.toString()+r.toString()}return n},logicMatch:function(t,e,r){var n;switch(t){case"=":n=e===r;break;case">":n=e>r;break;case"<":n=e<r;break;case">=":n=e>=r;break;case"<=":n=e===r;break;case"<>":case"NOT":n=e!=r}return n},mathMatch:function(t,e,r){var n;if(e=u.number(e),r=u.number(r),isNaN(e)||isNaN(r)){if("="===e[0]||"="===r[0])throw Error("NEED_UPDATE");throw Error("VALUE")}switch(t){case"+":n=e+r;break;case"-":n=e-r;break;case"/":if((n=e/r)==1/0)throw Error("DIV_ZERO");if(isNaN(n))throw Error("VALUE");break;case"*":n=e*r;break;case"^":n=Math.pow(e,r)}return n},callFunction:function(t,r){if(t=t.toUpperCase(),r=r||[],e.helper.SUPPORTED_FORMULAS.indexOf(t)>-1&&e.formulas[t])return e.formulas[t].apply(this,r);throw Error("NAME")},callVariable:function(t){var r=(t=t||[])[0];if(r&&(r=r.toUpperCase(),e.formulas[r]))return"function"==typeof e.formulas[r]?e.formulas[r].apply(this,t):e.formulas[r];throw Error("NAME")},cellValue:function(t){var r,n=e.custom.cellValue,a=e.matrix.getItem(t);if(e.utils.isFunction(n)){var i=e.utils.cellCoords(t),u=e.utils.translateCellCoords({row:this.row,col:this.col});r=a?a.value:n(i.row,i.col),e.utils.isNull(r)&&(r=0),u&&e.matrix.updateItem(u,{deps:[t]})}else r=a?a.value:document.getElementById(t).value,e.matrix.updateElementItem(this,{deps:[t]});if(a&&a.deps&&-1!==a.deps.indexOf(u))throw Error("REF");if(a&&a.error)throw Error(a.error);if(e.utils.isSet(r)){var o=e.helper.number(r);return isNaN(o)?r:o}throw Error("NOT_AVAILABLE")},cellRangeValue:function(t,r){var n=e.custom.cellValue,a=e.utils.cellCoords(t),i=e.utils.cellCoords(r),u=e.utils.iterateCells.call(this,a,i),o=[];if(e.utils.isFunction(n)){var l=e.utils.translateCellCoords({row:this.row,col:this.col});e.matrix.updateItem(l,{deps:u.index})}else e.matrix.updateElementItem(this,{deps:u.index});return o.push(u.value),o},fixedCellValue:function(t){return t=t.replace(/\$/g,""),e.helper.cellValue.call(this,t)},fixedCellRangeValue:function(t,r){return t=t.replace(/\$/g,""),r=r.replace(/\$/g,""),e.helper.cellRangeValue.call(this,t,r)}},o=function(t,r){var i=null,u=null;try{var o;n.setObj(r),i=n.parse(t),r instanceof HTMLElement?o=r.getAttribute("id"):r&&r.id&&(o=r.id);var l=e.matrix.getDependencies(o);if(-1!==l.indexOf(o))throw i=null,l.forEach(function(t){e.matrix.updateItem(t,{value:null,error:a.get("REF")})}),Error("REF")}catch(t){var c=a.get(t.message);u=c||a.get("ERROR")}return{error:u,result:i}};return{init:function(){n=new function(t){var e=function(){};e.prototype=Parser.lexer;var r=function(){this.lexer=new e,this.yy={}};r.prototype=Parser;var n=new r;return n.setObj=function(t){n.yy.obj=t},n.yy.parseError=function(t,e){throw{name:"Parser error",message:t,prop:e}},n.yy.handler=t,n}(e=this),e.formulas=Formula,e.matrix=new i,e.custom={},r&&e.matrix.scan()},version:"0.0.3",utils:{isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)},isUndefined:function(t){return"[object Undefined]"===Object.prototype.toString.call(t)},isNull:function(t){return"[object Null]"===Object.prototype.toString.call(t)},isSet:function(t){return!e.utils.isUndefined(t)&&!e.utils.isNull(t)},isCell:function(t){return!!t.match(/^[A-Za-z]+[0-9]+/)},getCellAlphaNum:function(t){var e=t.match(/\d+$/);return{alpha:t.replace(e,""),num:parseInt(e[0],10)}},changeRowIndex:function(t,r){var n=e.utils.getCellAlphaNum(t),a=n.alpha,i=parseInt(n.num+r,10);return i<1&&(i=1),a+""+i},changeColIndex:function(t,r){var n=e.utils.getCellAlphaNum(t),a=n.alpha,i=e.utils.toChar(parseInt(e.utils.toNum(a)+r,10)),u=n.num;i&&0!==i.length||(i="A");var o="$"===a[0]||!1,l="$"===a[a.length-1]||!1;return(i=(o?"$":"")+i)+""+(u=(l?"$":"")+u)},changeFormula:function(t,r,n){return r||(r=1),t.replace(/(\$?[A-Za-z]+\$?[0-9]+)/g,function(t){var a=e.utils.getCellAlphaNum(t),i=a.alpha,u=a.num;return e.utils.isNumber(n.col)&&(u=e.utils.toNum(i),n.col<=u)?e.utils.changeColIndex(t,r):e.utils.isNumber(n.row)&&n.row<u?e.utils.changeRowIndex(t,r):t})},updateFormula:function(t,r,n){var a,i;return-1!==["left","right"].indexOf(r)?a="col":-1!==["up","down"].indexOf(r)&&(a="row"),-1!==["down","right"].indexOf(r)?i=1*n:-1!==["up","left"].indexOf(r)&&(i=-1*n),a&&i?t.replace(/(\$?[A-Za-z]+\$?[0-9]+)/g,function(t){var r=e.utils.getCellAlphaNum(t).alpha,n="$"===r[0]||!1,u="$"===r[r.length-1]||!1;return"row"===a&&u?t:"col"===a&&n?t:"row"===a?e.utils.changeRowIndex(t,i):e.utils.changeColIndex(t,i)}):t},toNum:function(t){var r,n,a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=0;for(r=0,n=(t=e.utils.clearFormula(t)).length-1;r<t.length;r+=1,n-=1)i+=Math.pow(a.length,n)*(a.indexOf(t[r])+1);return i&&--i,i},toChar:function(t){for(var e="";t>=0;)e=String.fromCharCode(t%26+97)+e,t=Math.floor(t/26)-1;return e.toUpperCase()},cellCoords:function(t){var r=t.match(/\d+$/),n=t.replace(r,"");return{row:parseInt(r[0],10)-1,col:e.utils.toNum(n)}},clearFormula:function(t){return t.replace(/\$/g,"")},translateCellCoords:function(t){return e.utils.toChar(t.col)+""+parseInt(t.row+1,10)},iterateCells:function(t,r,n){var a={index:[],value:[]},i={start:0,end:0};i=r.col>=t.col?{start:t.col,end:r.col}:{start:r.col,end:t.col};var u={start:0,end:0};u=r.row>=t.row?{start:t.row,end:r.row}:{start:r.row,end:t.row};for(var o=i.start;o<=i.end;o++)for(var l=u.start;l<=u.end;l++){var c=e.utils.toChar(o)+(l+1),s=e.helper.cellValue.call(this,c);a.index.push(c),a.value.push(s)}return e.utils.isFunction(n)?n.apply(n,[a]):a},sort:function(t){return function(e,r){return(e<r?-1:e>r?1:0)*(t?-1:1)}}},helper:u,parse:o}};